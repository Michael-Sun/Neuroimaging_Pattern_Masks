cd('/Users/tor/Documents/Code_Repositories/Neuroimaging_Pattern_Masks/Atlases_and_parcellations/2018_Wager_combined_atlas')

savedir = '/Users/tor/Documents/Code_Repositories/Neuroimaging_Pattern_Masks/Atlases_and_parcellations/2018_Wager_combined_atlas';

% Cortex from Glasser
% Striatum, STN, VTA, pallidum, BST from Pauli 2018  [alt striatum: Brainnetome] [alt: Keuken RN SN STN Pallidum]
% Cerebellum from Diedrichsen
% Striatal subregions from Pauli 2016
% Thalamus from Morel  [alt: Brainnetome]
% Basal forebrain, hipp/MTL, amy from SPM Anatomy 
% Brainstem from Shen
% Specific brainstem nuclei from Keren, Brooks, Tor SPM5 PAG [redo], 

% SPM Anatomy
% Septum/DBB, BNM, Astr?, 
% CA1, CA2, CA3, Subiculum, DG
% BL, SF, CM, HATA

% Glasser: 180 regions
% CIT168 : 'NAC' 'BST_SLEA' 'GPe' 'GPi' 'SNc' 'RN' 'SNr' 'PBP' 'VTA' 'VeP' 'Haben' 'Hythal' 'Mamm_Nuc' 'STN'


% Brainstem mask: 'canlab_brainstem.img'.  CIT168 brainstem masked with
% SPM8 canonical brainstem segmentation, then manually edited/cleaned.

% Atlases done:
% Keuken_create_atlas_object
% CIT168_create_atlas_object
% GlasserHCP_create_atlas_object
% SUIT_create_atlas_object
% Brainnetome_create_atlas_object
% SPManatomy_create_atlas_object

glasserfile = which('Glasser2016HCP_atlas_object.mat');
citfile = which('CIT168_MNI_subcortical_atlas_object.mat');
suitfile = which('SUIT_Cerebellum_MNI_atlas_object.mat');
shenfile = which('Shen_atlas_object.mat');
morelfile = which('Morel_thalamus_atlas_object.mat');
spmanatfile = which('SPMAnatomy22c_atlas_object.mat');
paulifile = which('Pauli2016_striatum_atlas_object.mat');
bnfile = which('Brainnetome_atlas_object.mat');

%% Start with Glasser cortex

glasser = load(glasserfile, 'atlas_obj'); glasser = glasser.atlas_obj;


%% Map in CIT168 regions (BG, some subcortex)

% ** may need 'split into contiguous' function **

cit = load(citfile); cit = cit.atlas_obj;
wh_regions = cit.labels(3:end);

%subregions = select_atlas_subset(cit, wh_regions); orthviews(subregions); n = num_regions(subregions)

atlas_obj = merge_atlases(glasser, cit, wh_regions);

atlas_obj.atlas_name = 'CANlab_2018_combined';

clear cit glasser

%% Map in SUIT MNI regions for cerebellum

suit = load(suitfile); suit = suit.atlas_obj;

%wh_regions = cit.labels(3:end);
%subregions = select_atlas_subset(cit, wh_regions); orthviews(subregions); n = num_regions(subregions)

atlas_obj = merge_atlases(atlas_obj, suit);

clear suit

%% Map in brainstem regions from canlab_load_ROI

% 'cm'      Centromedian thalamus   Morel thalamus atlas, Krauth 2010
% 'md'      Mediodorsal thalamus    Morel thalamus atlas, Krauth 2010
% 'lgn'     Lateral geniculate nuc  Morel thalamus atlas, Krauth 2010
% 'mgn'     Medial geniculate nuc   Morel thalamus atlas, Krauth 2010
% 'VPthal'  Ventral posterior thal  Morel thalamus atlas, Krauth 2010
% 'intralaminar_thal' Intralaminar  Morel thalamus atlas, Krauth 2010

regionnames = {'cm' 'md' 'lgn' 'mgn' 'VPthal' 'intralaminar_thal'} ;

for i = 1:length(regionnames)
    regionname = regionnames{i};
    
    [~, roi_atlas] = canlab_load_ROI(regionname);
    orthviews(roi_atlas);
    a = input(' press');
    
end


%% Map in Pauli regions for striatum

pauli = load(paulifile); pauli = pauli.atlas_obj;

%wh_regions = cit.labels(3:end);
%subregions = select_atlas_subset(cit, wh_regions); orthviews(subregions); n = num_regions(subregions)

atlas_obj = merge_atlases(atlas_obj, pauli, 'noreplace');

clear pauli


%% Save temporary

save(fullfile(savedir, 'CANlab_combined_atlas_object_2018.mat'), 'atlas_obj');


%% Map in Morel thalamus regions, without replacing existing

morel = load(morelfile); morel = morel.atlas_obj;

%wh_regions = cit.labels(3:end);
%subregions = select_atlas_subset(cit, wh_regions); orthviews(subregions); n = num_regions(subregions)

atlas_obj = merge_atlases(atlas_obj, morel, 'noreplace');

% *** seems to break after adding thal in orthviews

% clear morel

orthviews(atlas_obj)

%% SPM Anatomy

% ****labels are wrong

spmanat = load(spmanatfile); spmanat = spmanat.atlas_obj;

wh_regions = {'Subiculum' 'CA1_Hippocampus_'}
subregions = select_atlas_subset(spmanat, wh_regions); orthviews(subregions); n = num_regions(subregions)

%% Add brainnetome without replacement
% Glasser is too sparse in some areas of cortex.  Fill in missing areas
% with brainnetome.

bn = load(bnfile); bn = bn.atlas_obj;

%wh_regions = cit.labels(3:end);
%subregions = select_atlas_subset(cit, wh_regions); orthviews(subregions); n = num_regions(subregions)

atlas_obj = merge_atlases(atlas_obj, bn, 'noreplace');

orthviews(atlas_obj)

clear bn



